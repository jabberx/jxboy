<html>
<head>
<style>
* {
    -webkit-touch-callout:none;
    -webkit-user-select:none;
    -moz-user-select:none;
    -ms-user-select:none;
    user-select:none;
    cursor:default;
}
</style>
<script>
function $(req) {
    if (req.indexOf('#')===0) 
        return document.getElementById(req.substring(1));
    return document.getElementsByClassName(req.substring(1));
}

const RAM = 1024;
const CALL_STACK = 2048;
const STACK = 1024;

var stepping = true;
var m = [];
var s = [];
var cs = [];
var mp = 0;
var sp = 0;
var csp = 0;
var pp = 0;
var mstep = 1;
var d1 = 'Â¤';
var d0 = ' ';
var vramb = 1;
var vrams = 16*16/8;
var dw = 16;
var dh = 16;
var code = "";

function getVRAMbit(bitn) {
    return (m[vramb + Math.floor(bitn/8)]&(1<<(bitn%8))) != 0 ? 1 : 0;
}

function updateDisplay() {
    var cells = $('#cells');
    cells.innerHTML = "";
    for (var y = 0; y < dh; y++)
        for (var x = 0; x < dw; x++)
            cells.innerHTML += 
                (getVRAMbit(x+y*dw) == 1 ? d1 : d0) +
                (x == dw-1 ? '\n' : '');
}

function runcmd(cmd) {
    switch(cmd) {
case 'w': break;
case '.': pp = pp-1; break;
case '^': s[sp] = m[mp]; sp++; break;
case 'y': sp--; m[mp] = s[sp]; break;
case '"': s[sp] = s[sp-1]; sp++; break;
case '\'': sp--; break;
case ',': var temp=sp[sp-1];sp[sp-1]=sp[sp-2];sp[sp-2]=temp; break;
case '_': sp=0; break;
case 'x': s.reverse(); break;
case '<': mp-=mstep; break;
case '>': mp+=mstep; break;
case '[': mstep/=2; mstep=mstep<1?1:mstep; break;
case ']': mstep*=2; break;
case 'z': mstep=1; break;
case '=': mp=s[sp-2]+(s[sp-1]<<8); break;
case '+': var i=m[mp]+m[mp+1];m[mp]=i&255;m[mp-1]=(i-m[mp])>>8; break;
case '-': var i=m[mp]-m[mp+1];m[mp]=i%256;m[mp-1]=i>=0?0:255-m[mp]; break;
case '*': var i=m[mp]*m[mp+1];m[mp]=i&255;m[mp-1]=(i-m[mp])>>8; break;
case '/': var i=m[mp]/m[mp+1];m[mp]=Math.floor(i);m[mp-1]=(i-Math.floor(i))*255; break;
case '|': m[mp] |= m[mp+1]; break;
case '&': m[mp] &= m[mp+1]; break;
case '~': m[mp] = ~m[mp]; break;
case '%': m[mp] ^= m[mp+1]; break;
case '?': pp = m[mp]==0 ? pp + s[sp-1]-127-1 : pp; break;
case '!': pp = m[mp]!=0 ? pp + s[sp-1]-127-1 : pp; break;
case ':': pp += s[sp-1]-127-1; break;
case '#': pp = s[sp-2]+s[sp-1]<<8-1; break;
case '`': cs[csp] = pp; csp++; pp += s[sp-1]-127-1; break;
case '@': cs[csp] = pp; csp++; pp = s[sp-2]+s[sp-1]<<8-1; break;
case ';': pp = cs[csp-1]-1; csp--; break;
case '{': m[mp-1] = m[mp]; break;
case '}': m[mp+1] = m[mp]; break;
case '(': var temp=m[mp-1];m[mp-1]=m[mp];m[mp]=temp; break;
case ')': var temp=m[mp+1];m[mp+1]=m[mp];m[mp]=temp; break;
case '0': m[mp] = (m[mp]&0b11110000) | 0; break;
case '1': m[mp] = (m[mp]&0b11110000) | 1; break;
case '2': m[mp] = (m[mp]&0b11110000) | 2; break;
case '3': m[mp] = (m[mp]&0b11110000) | 3; break;
case '4': m[mp] = (m[mp]&0b11110000) | 4; break;
case '5': m[mp] = (m[mp]&0b11110000) | 5; break;
case '6': m[mp] = (m[mp]&0b11110000) | 6; break;
case '7': m[mp] = (m[mp]&0b11110000) | 7; break;
case '8': m[mp] = (m[mp]&0b11110000) | 8; break;
case '9': m[mp] = (m[mp]&0b11110000) | 9; break;
case 'a': m[mp] = (m[mp]&0b11110000) | 0xa; break;
case 'b': m[mp] = (m[mp]&0b11110000) | 0xb; break;
case 'c': m[mp] = (m[mp]&0b11110000) | 0xc; break;
case 'd': m[mp] = (m[mp]&0b11110000) | 0xd; break;
case 'e': m[mp] = (m[mp]&0b11110000) | 0xe; break;
case 'f': m[mp] = (m[mp]&0b11110000) | 0xf; break;
case 'g': m[mp] = (0<<4)|(m[mp]&0b1111); break;
case 'h': m[mp] = (1<<4)|(m[mp]&0b1111); break;
case 'i': m[mp] = (2<<4)|(m[mp]&0b1111); break;
case 'j': m[mp] = (3<<4)|(m[mp]&0b1111); break;
case 'k': m[mp] = (4<<4)|(m[mp]&0b1111); break;
case 'l': m[mp] = (5<<4)|(m[mp]&0b1111); break;
case 'm': m[mp] = (6<<4)|(m[mp]&0b1111); break;
case 'n': m[mp] = (7<<4)|(m[mp]&0b1111); break;
case 'o': m[mp] = (8<<4)|(m[mp]&0b1111); break;
case 'p': m[mp] = (9<<4)|(m[mp]&0b1111); break;
case 'q': m[mp] = (10<<4)|(m[mp]&0b1111); break;
case 'r': m[mp] = (11<<4)|(m[mp]&0b1111); break;
case 's': m[mp] = (12<<4)|(m[mp]&0b1111); break;
case 't': m[mp] = (13<<4)|(m[mp]&0b1111); break;
case 'u': m[mp] = (14<<4)|(m[mp]&0b1111); break;
case 'v': m[mp] = (15<<4)|(m[mp]&0b1111); break;
case '\\': m[mp] = 0; break;
case '$': m[mp]=0xFF; break;
    }
}

document.onkeydown=function(event){
    switch(event.keyCode) {
        case 37: m[0] |= 1<<0; break;
        case 39: m[0] |= 1<<1; break;
        case 38: m[0] |= 1<<2; break;
        case 40: m[0] |= 1<<3; break;
        case 32: m[0] |= 1<<4; break;
        case 16: m[0] |= 1<<5; break;
        case 88: m[0] |= 1<<6; break;
        case 67: m[0] |= 1<<7; break;
    }
}

document.onkeyup=function(event){
    switch(event.keyCode) {
        case 37: m[0] &= ~(1<<0); break;
        case 39: m[0] &= ~(1<<1); break;
        case 38: m[0] &= ~(1<<2); break;
        case 40: m[0] &= ~(1<<3); break;
        case 32: m[0] &= ~(1<<4); break;
        case 16: m[0] &= ~(1<<5); break;
        case 88: m[0] &= ~(1<<6); break;
        case 67: m[0] &= ~(1<<7); break;
    }
    console.log(event.keyCode);
}

function reset() {
     m = [];
    s = [];
    cs = [];
    mp = 0;
    sp = 0;
    csp = 0;
    pp = 0;
    mstep = 1;   
}

$('#runbtn').onclick = function() {
    stepping = false;
    code=$('#code').value;
    reset();
}

function step() {
    $('#cmdsp').innerHTML = code[pp];
    runcmd(code[pp]);
    if (mp>=RAM) mp = 0;
    if (sp>=STACK) sp = 0;
    if (csp>=CALL_STACK) csp = 0;
    pp++;
    if (pp > code.length-1) return false;
    return true;
}


$('#stepbtn').onclick = function() {
     stepping = true;
     code=$('#code').value;
     step();
}

$('#stopbtn').onclick = function() {
    stepping = true;
    pp = 0;
    reset();
}

setInterval(function() {
    if (!stepping)
    for(var i = 0; i < 100; i++)
        if (!step()) break;
    updateDisplay();
}, 100);
</script>
</head>
<body>
<div id='display' style='font-weight:bold;font-size:14px;font-family:monospace;letter-spacing:-.5px;line-height:55%'>
<pre id='cells' style='border: 3px double silver;width:116px'>
</pre>
</div>
<div style='font-family:tahoma; font-size:8px; width:116px'>controls:<br/>left, right, up, down, <br/>space, left shift, x, c</div><br/>
<div><span style='font-family:monospace; font-size:8px;' id='cmdsp'></span></div>
<textarea id='code' style='overflow:auto;width:200px;height:200px;right:0;top:0;position:absolute;'>
>nd^$>:
</textarea><br/>
<button id='runbtn'>Run</button>
<button id='stepbtn'>Step</button>
<button id='stopbtn'>Stop</button>
</body>
</html>
